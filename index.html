<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebDAV文件管理器</title>
    <link rel="shortcut icon" href="logo.ico" type="image/x-icon">
    <style>
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
        }

        .connect-form-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .connect-form-container h1 {
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 24px;
        }

        .connect-form-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .connect-form-container input:focus {
            border-color: #409eff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(64,158,255,.2);
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
            transition: all 0.3s;
        }

        button.primary {
            background: #409eff;
        }

        button.success {
            background: #67c23a;
        }

        button.secondary {
            background: #909399;
        }

        button.danger {
            background: #f56c6c;
        }

        .file-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .file-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
        }

        .file-item {
            padding: 12px 15px;
            transition: all 0.3s;
        }

        .file-item:hover {
            background: #f5f7fa;
        }

        .file-item.selected {
            background: #ecf5ff;
            border-left: 3px solid #409eff;
        }

        .progress-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-height: 60vh;
            overflow-y: auto;
        }

        .progress-item {
            margin: 8px 0;
        }

        .progress-bar {
            height: 12px;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: #409eff;
            transition: width 0.3s ease;
        }

        .upload-progress .progress-fill {
            background: #67c23a;
        }

        #loading {
            display: none;
            color: #666;
            margin: 10px;
        }

        .error {
            color: red;
            margin-left: 10px;
        }

        input[type="text"], input[type="password"] {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        input[type="text"]#serverUrl,
        input[type="text"]#username,
        input[type="password"]#password {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="connect-form-container">
        <h1>WebDAV文件管理器</h1>
        <input type="text" id="serverUrl" placeholder="服务器地址 (http:// 或 https://)">
        <input type="text" id="username" placeholder="用户名">
        <input type="password" id="password" placeholder="密码">
        <button class="primary" onclick="connect()">连接服务器</button>
        <span id="loading">加载中...</span>
        <span class="error" id="errorMsg"></span>
        <div>
            <img id="randomImage" src="" alt="随机图片" style="margin-top: 20px; max-width: 100%; border-radius: 8px;">
        </div>
    </div>

    <div id="toolbar" style="display: none; margin: 20px 0; text-align: right;">
        <button class="success">新建文件夹</button>
        <button class="secondary">上传文件</button>
        <button class="secondary" id="renameBtn" disabled>重命名</button>
        <button class="danger" id="deleteBtn" disabled>删除</button>
        <button class="secondary" onclick="refreshCurrentDirectory()">刷新</button>
    </div>

    <div id="fileList" style="margin-top:20px"></div>
    <div class="progress-container" id="progressContainer"></div>

    <script>
        const builtInServerUrl = '';
        const builtInUsername = '';
        const builtInPassword = '';

        let currentAuth = '';
        let webdavRootUrl = '';
        let currentPath = '';
        let selectedItem = null;
        const activeTransfers = new Map();

        function saveFormData() {
            const formData = {
                serverUrl: document.getElementById('serverUrl').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
            localStorage.setItem('webdavFormData', JSON.stringify(formData));
        }

        function loadFormData() {
            const savedData = localStorage.getItem('webdavFormData');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    document.getElementById('serverUrl').value = formData.serverUrl || '';
                    document.getElementById('username').value = formData.username || '';
                    document.getElementById('password').value = formData.password || '';
                } catch (e) {
                    console.error('加载保存的数据失败:', e);
                }
            }
        }

        async function connect() {
            const serverInput = document.getElementById('serverUrl').value || builtInServerUrl;
            const username = document.getElementById('username').value || builtInUsername;
            const password = document.getElementById('password').value || builtInPassword;

            try {
                if (!serverInput.startsWith('http://') && !serverInput.startsWith('https://')) {
                    throw new Error('服务器地址必须以http://或https://开头');
                }
                webdavRootUrl = new URL(serverInput).href;
            } catch (e) {
                showError(`服务器地址无效: ${e.message}`);
                return;
            }

            currentAuth = btoa(`${username}:${password}`);

            try {
                await fetchDirectory(webdavRootUrl);
                saveFormData();
                document.getElementById('toolbar').style.display = 'block';
                document.querySelector('.connect-form-container').style.display = 'none';
            } catch (e) {
                showError(`连接失败: ${e.message}`);
            }
        }

        async function fetchDirectory(path) {
            if (!path.endsWith('/')) path += '/';

            document.getElementById('loading').style.display = 'inline';
            try {
                const response = await fetch(path, {
                    method: 'PROPFIND',
                    headers: {
                        'Authorization': `Basic ${currentAuth}`,
                        'Depth': '1',
                        'Content-Type': 'text/xml; charset=utf-8'
                    },
                    body: `<?xml version="1.0"?>
                        <d:propfind xmlns:d="DAV:">
                            <d:prop>
                                <d:displayname/>
                                <d:getcontentlength/>
                                <d:getlastmodified/>
                                <d:resourcetype/>
                            </d:prop>
                        </d:propfind>`
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.text();
                const items = parseResponse(data, path)
                    .filter(item => item.href !== path && !item.href.endsWith('.DS_Store/'));

                renderFileList(items, path);
            } catch (e) {
                showError(`操作失败: ${e.message}`);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function parseResponse(xmlText, baseUrl) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, "text/xml");
            return Array.from(doc.getElementsByTagNameNS('DAV:', 'response')).map(item => {
                const href = item.getElementsByTagNameNS('DAV:', 'href')[0].textContent;
                const fullHref = new URL(href, baseUrl).href;
                const isDir = item.getElementsByTagNameNS('DAV:', 'collection').length > 0;

                const propStat = item.getElementsByTagNameNS('DAV:', 'propstat')[0];
                const props = propStat.getElementsByTagNameNS('DAV:', 'prop')[0];

                const pathname = new URL(fullHref).pathname;
                const cleanPath = decodeURIComponent(pathname).replace(/\/$/, '');
                const fileName = cleanPath.split('/').pop() || '';

                return {
                    href: fullHref,
                    name: fileName,
                    type: isDir ? 'directory' : 'file',
                    size: props.getElementsByTagNameNS('DAV:', 'getcontentlength')[0]?.textContent || null,
                    modified: props.getElementsByTagNameNS('DAV:', 'getlastmodified')[0]?.textContent || null
                };
            });
        }

        function renderFileList(items, path) {
            currentPath = path;
            const container = document.getElementById('fileList');

            container.innerHTML = `
                <div class="file-list">
                    ${generateBreadcrumb(path)}
                    <div class="file-header">
                        <div class="file-name">名称</div>
                        <div class="file-size">大小</div>
                        <div class="file-modified">修改时间</div>
                        <div class="file-actions">操作</div>
                    </div>
                    ${items.map(item => `
                        <div class="file-item ${selectedItem === item.href ? 'selected' : ''}"
                            ondblclick="toggleSelection('${item.href}')">
                            <div class="file-name" ${item.type === 'directory' ? `ondblclick="enterDirectory('${item.href}')"` : ''}>
                                ${item.type === 'directory' ? '&#128193;' : '&#128196;'} 
                                ${item.name}
                            </div>
                            <div class="file-size">${formatSize(item.size)}</div>
                            <div class="file-modified">${formatDate(item.modified)}</div>
                            <div class="file-actions">
                                ${item.type === 'file' ? 
                                    `<button class="secondary" onclick="downloadFile('${item.href}')">下载</button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                    ${items.length === 0 ? `
                        <div class="file-item" style="justify-content:center; color:#6c757d;">
                            空目录
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('renameBtn').disabled = !selectedItem;
            document.getElementById('deleteBtn').disabled = !selectedItem;
        }

        function toggleSelection(href) {
            selectedItem = selectedItem === href ? null : href;
            fetchDirectory(currentPath);
        }

        function generateBreadcrumb(path) {
            const base = new URL(webdavRootUrl);
            const basePath = decodeURIComponent(base.pathname).replace(/\/?$/, '/');
            const current = new URL(path);
            const currentPathname = decodeURIComponent(current.pathname).replace(/\/?$/, '/');
            const relativePath = currentPathname.slice(basePath.length);
            const segments = relativePath.split('/').filter(Boolean);

            return `<div class="breadcrumb">
                <a href="#" onclick="enterDirectory('${base.href}')">&#127968;主页</a>
                ${segments.length > 0 ? ' / ' : ''}
                ${segments.map((seg, i) => {
                    const urlSegments = segments.slice(0, i+1);
                    const url = new URL(basePath + urlSegments.join('/') + '/', base.href);
                    return i === segments.length-1 ? 
                        `<span>${decodeURIComponent(seg)}</span>` : 
                        `<a href="#" onclick="enterDirectory('${url.href}')">${decodeURIComponent(seg)}</a> / `;
                }).join('')}
            </div>`;
        }

        function formatSize(bytes) {
            if (!bytes) return '-';
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = parseFloat(bytes);
            for (let unit of units) {
                if (size < 1024) return `${size.toFixed(1)} ${unit}`;
                size /= 1024;
            }
            return `${size.toFixed(1)} GB`;
        }

        function formatDate(dateStr) {
            try {
                return new Date(dateStr).toLocaleString('zh-CN');
            } catch {
                return dateStr;
            }
        }

        function showError(message) {
            document.getElementById('errorMsg').textContent = message;
            setTimeout(() => document.getElementById('errorMsg').textContent = '', 3000);
        }

        async function enterDirectory(path) {
            if (!path.endsWith('/')) path += '/';
            await fetchDirectory(path);
        }

        function refreshCurrentDirectory() {
            if (!currentAuth) {
                showError('请先连接到服务器');
                return;
            }
            if (!currentPath) {
                showError('当前路径不可用');
                return;
            }
            selectedItem = null;
            fetchDirectory(currentPath);
        }

        window.onload = () => {
            loadFormData();
            if (builtInServerUrl) {
                document.getElementById('serverUrl').value = builtInServerUrl;
            }
            if (builtInUsername) {
                document.getElementById('username').value = builtInUsername;
            }
            if (builtInPassword) {
                document.getElementById('password').value = builtInPassword;
            }
            const hasBuiltInConfig = builtInServerUrl || builtInUsername || builtInPassword;
            if (hasBuiltInConfig) {
                setTimeout(() => connect(), 500);
            } else {
                const savedData = localStorage.getItem('webdavFormData');
                if (savedData) {
                    setTimeout(() => connect(), 500);
                }
            }

            // 加载随机图片
            const randomImageUrl = `https://api.200036.xyz${Math.floor(Math.random() * 1000)}`;
            document.getElementById('randomImage').src = randomImageUrl;
        };
    </script>
</body>
</html>
